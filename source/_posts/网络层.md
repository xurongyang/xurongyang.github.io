---
title: 网络层
date: 2017-01-06 14:50:01
tags: [网络]
categories:
- 网络
---
### 提供的服务
1. 面向连接（虚电路）：虚电路是网络层向传输层提供的一种使所有分组按顺序到达目的端系统的可靠数据传送方式。进行数据交换的两个端系统之间存在着一条为它们服务的虚电路。
2. 无连接：在需要经过很多个路由的通信线路上，数据报通过路由器自行选择走的线路。这样的通信是所谓的【尽最大努力交付】的不可靠传输。

现在的因特网都用的是【数据报服务】，因为现在的主机比较强大，信息传输的可靠性可以由主机来完成，在TCP/IP协议中，一般是TCP层来完成。

### IP
和IP协议配套的有3个协议：

* 地址解析协议ARP   
* 网际控制报文协议ICMP   
* 网际组管理协议IGMP

#### 目的
IP协议是用来转发数据的，用来告诉数据要发送到那个机器上。但是计算机在转发数据的时候，最终都是通过MAC地址转发完成的，知道源主机和目标主机的MAC地址，就可以把数据发送过去。那既然这样，为什么我们还要用IP协议？

具体原因是这样的，生产适配器的厂商很多，然后就衍生出各种格式的MAC地址，MAC地址不统一，数据就发送不了！！！！！这时候，IP协议从天而降。把各种异构网络（不同的寻址方案，不同的超时控制，不同的路由选择技术……）互连起来，形成了一个【虚拟互连网络】。
使用了IP协议后，网络层看起来就好像一个统一的网络。
#### 分类
* 分类的IP地址
* 子网的划分
* 构成超网

#### 分类的IP地址
分类的IP地址是由两部分组成，即 IP地址::={<网络号>，<主机号>}     不知道是哪个国家的惯例，“：：=”的意思是“定义为”。咱就这样记吧，也比较好记。

IP地址是由ICANN这个机构给分配的，它只分配 网络号，所以一个网络号在因特网内必须唯一，而主机号在它前面的网络号中也是唯一的。可见IP地址在整个因特网范围内是唯一的。

第一个阶段，分类的IP地址共有5类地址
![](/images/20131027111130218.jpeg)

具体就是图上这样的，A类，B类，C类地址的网络号字段分别是1，2，3字节场，最前面的1~3位是类别位，数值规定分别是0， 10， 110

D类地址用于多播（一对多通信）   E类地址作为保留为以后用。

IP地址都是32位的二进制代码，这样的代码对于计算机来说是方便了，但是对于我们来说就不好读了，所以，规定用 点分十进制记法 来表示IP，大家肯定都见过，比如说202.113.88.91这样的地址，其实就是11001010 1110001 1011000 1011011的点分十进制记法。

最常用的IP是A，B，C三类。下面给大家看一看各类IP的实际范围。

A类： 1.0.0.1-126.255.255.254（实际IP）    1.0.0.0-127.255.255.254（理论上的IP） 为什么会出现这种情况?下面再讲，先看完IP范围

B类： 128.0.0.1-191.255.255.254（实际IP）  128.0.0.0-191.255.255.254（理论IP）     
  
C类： 192.0.0.1-223.255.255.254（实际IP）  192.0.0.0-223.255.255.254（理论IP）

IP地址中，全0主机号字段表示该IP地址是“本主机”所连接到的单个网络地址。比如1.0.1.1就表示网络地址为1.0.0.0  

一般，全零（“0．0．0．0”）地址对应于当前主机。全“1”的IP地址（“255．255．255．255”）是当前子网的广播地址。

IP地址有四个特点：

* IP地址是分等级的地址结构。IP地址管理机构分配IP时，只分配网络号（第一级），主机号（第二级）由得到网络号的单位自行分配，并且，路由器仅根据目的主机的网络号来转发分组
* IP地址是主机和链路的接口，若主机要练到两个网络，则需要两个IP，网络号必须不同，这种主机称为多归属主机。
* 具有同样网络号的主机的集合就称为一个网络。就是说，只要网络号相同，就是在同一个网络里。
* 所有网络号都是平等的

#### IP地址与硬件地址
![](/images/20131027131103343.jpeg)
从网络层进到数据链路层的时候，IP数据报首部就被当做数据链路层的数据封装进去了！所以说，数据链路层是看不见数据报的IP地址的。
![](/images/20131027131430906.jpeg)
在IP层中，源IP地址和目的IP地址始终不变。而数据链路层中的MAC地址一直在随着路由器的转发改变。这就是他们最大的区别了！
但是这会引起另外一个问题，不知道大家注意没有，MAC地址一直在变，那主机或者路由器怎么知道MAC帧首部应该填入什么硬件地址？好。。。这就是下面要说的问题，也是重点：【地址解析协议ARP】
#### 地址解析协议ARP
ARP的作用就是这个：  IP地址→ARP协议→硬件地址

每个主机中都设有的一个【ARP高速缓存】，ARP高速缓存中包含 本局域网上的各主机和路由器的IP地址到硬件地址的映射表。就是通过这个表，IP地址就可以找到对应的硬件地址。

那最开始的时候是怎么生成这个表的呢？具体是这样
![](/images/20131028124638765.jpeg)

如果ARP高速缓存中没有目标IP对应的物理地址，主机就给局域网内所有的主机发送广播，然后对应IP的主机收到后，以单播的形式回答ARP请求。这时候，发送请求的主机A就把目的IP地址主机B的【IP与MAC地址的映射】写入到A自己的ARP高速缓存中。同时，B也得到了A的IP和MAC地址的对应，也将此映射写到B自己的ARP高速缓存中。

当然，既然叫 ARP高速缓存 了，那它就是一个缓存，既然是缓存就一定会在一定时间之后删除掉。 这个时间，就叫【生存时间】，每个映射项目都会设置一个生存时间。这种机制是保持网络通信的优良解决方案。

防止出现这种情况：就加入A的ARP高速缓存中有B的硬件地址的映射，但是B的适配器坏了，换了块新的。这时候，A就联系不上B了。因为A中存的B的硬件地址已经更改了。然后过了一小段时间，A的ARP高速缓存删除了B的原先的硬件地址，然后重新广播找到B的新硬件地址。

上面说的是在同一局域网的情况，如果要通信的两台主机不在同一局域网的话，就解析出要转发的路由器的MAC地址，把数据发给路由器，路由器通过路由表转发出去，最后通过最后一个路由再解析出要目标IP的MAC地址，传输数据！

另外，这种解析都是自动进行的，对用户来说是透明的！用户完全不知道发生了些什么。

到了这里，我再提一提为什么要用IP地址！ARP是把IP地址转为MAC地址的协议，既然最后的传送都用的硬件地址，为什么还要使用IP地址多此一举的转化？就像我最开始说的，MAC地址的规格不统一~~~~~，所以，所以，用IP地址来统一所有的不同的异构网络，不同的MAC地址！

#### IP数据报的格式
IP数据包你由两部分组成，首部和数据。首部又由两部分组成，分别是20字节的固定长度和固定部分后的可选字段

#### IP首部
* 版本： 指IP协议的版本，通信双方版本必须一致，现在一般用的IPv4，以后会用到IPv6

* 首部长度： 占4位，最长60字节，最小20字节，不要问为什么，，，，不要深究，当时我以深究就陷进去了，简单的这个地方纠结了好几天。

* 区分服务： 只有在区分服务的时候，这个字段才起作用。貌似这个字段现在没什么用。。。。。

* 总长度：  指首部和数据的总和，占16位，最长可达65535（二进制16个1），但IP在数据链路层规定了数据帧中 数据字段的最大长度，一般称为【最大传送单元MTU】

* 标识： 具有相同标识的数据报片段最后能正确的组装在一起。标识是这样生成的 →  IP软件中有个计数器，一旦生成数据报，计数器就+1并且将值赋给标识字段。数据报太长而要分片时，这个值就被赋给所有标识字段。

* 标志： 有3位，只有两位有意义。 最低位（最后一位）是MF， MF=1 表示后面“还有分片” MF=0表示这是若干个数据报片中的最后一个。中间位是DF，意思是“不能分片”。 DF=0才允许分片

* 片偏移： 较长分组分片后，某片在原分组中的位置。即 相对于用户数据报字段的起点，该片从何处开始。片偏移以8个字节为偏移单位。（后面给大家一个书上的例子讲解一下）

* 生存时间：  表明数据报在网络中的寿命，现在以“跳数”为单位，没跳过一个路由器跳数-1，跳数为0则数据部被丢弃

* 协议：  指出该数据报携带的数据是使用何种协议

* 首部检验和：  这个字段只检验数据部首部，不包括数据部分。

#### IP层转发分组的流程
IP层转发分组的规则其实很简单，  分组从一个路由转发到另一个路由，最后一个路由向目的主机交付

什么是最后一个路由？就是你分组转发的某个路由，而路由连接到分组要去的网络，然后这个路由就直接把分组交付了
![](/images/20131109210023718.png)
路由表里的信息很简单，主要就是（目的网络地址，下一跳地址）

这样，路由器根据分组的IP地址查找对应的目的网络地址，得出下一跳地址（目的地址对应的下一跳地址是根据路由选择协议自行计算出来的）。

还有特定主机路由，特定主机路由即指某一台主机直接指定一个路由，我的分组就从这个路由转发出去

还有默认路由，对IP数据包中的目的地址找不到存在的其他路由时，路由器所选择的路由。

#### 划分子网
划分子网的原因就是，IP地址不够用了，现在的分配方式比较浪费IP地址。所以，现在就“划分子网”了。

思路：

1. 划分子网是一个单位的网络内部的事情（比如一个大学内部），整个大学的网络对外人任然表现为一个网络
2. 从主机号，借若干位作为子网号（借用以后，主机号就少了，借多少就少多少）。然后二级IP就变成了三级IP，IP地址：：= {<网络号>，<子网号>，<主机号>}
3. 发送分组的时候任然和以前一样，就是最后的一个路由（即到了本单位网络上的路由），通过目的地址和子网掩码得到 子网号，然后发送分组~~


子网中最重要的东西子网掩码，子网掩码的作用就是为了让本单位中的路由器找到所划分的子网。如果没有划分子网，默认的子网掩码就是下面这样

A类地址的默认子网掩码是255.0.0.0，换算成二进制，就是11111111 00000000 00000000 00000000

B类地址的默认子网掩码是255.255.0.0，换算成二进制，就是11111111 11111111 00000000 00000000

C类地址的默认子网掩码是255.255.255.0，换算成二进制，就是11111111 11111111 11111111 00000000

如果是划分了呢？那就是这样的，比如现在划分A类的子网

子网号的位数2位（即借用主机号2位）     11111111 11000000 00000000 00000000（二进制就是这样的） 换成10进制255.192.0.0（子网掩码） 

 子网号的位数3位（即借用主机号3位）     11111111 11100000 00000000 00000000（二进制就是这样的） 换成10进制255.224.0.0（子网掩码）
 
子网数和每个子网中主机数的确认是这样的举例：假如子网号有两位，则可能的子网数共为2²，但是全0和全1不可用，所以子网数为2²-2=2，主机数2^22-2

那通过子网掩码和IP地址如何计算出网络地址呢？很简单啊，做个简单的与运算……
举例：IP地址为141.14.72.24    子网掩码为255.255.192.0 网络地址就这样求
目的地址（十进制）：10001101 00001110 01001000 00011000
子网掩码（十进制）：11111111 11111111 11000000 00000000
进行与运算，最后得到：10001101 00001110 01000000 00000000，换算成10进制就是141.14.64.0（这个就是网络地址了~）
