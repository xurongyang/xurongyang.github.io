---
title: 日志文件系统
date: 2017-02-26 22:32:16
tags: [存储]
categories:
- 存储
---
### 核心问题
崩溃一致性问题
### 写文件的几个步骤
1. 写inode
2. 写bitmap
3. 写data block

![](/images/QQ20170226-230057@2x.png)
### 不一致现象
上面的三个步骤，可能只有某一个成功，或者某两个成功都会导致一些不一致的问题
### 日志（write-ahead logging）
Linux ext3 and ext4用的就是这种方式
#### 基本理论
当要更新磁盘数据时，我们先记录一点日志，说明我们要做的事情，于是叫做**写前日志**。保证写前日志成功后再开设写操作，就能够在出问题的时候进行恢复。
#### 基本流程
![](/images/QQ20170226-231327@2x.png)

* Txb包含**transaction identifier (TID).**
* TxE是事务结束的标志，也包含**TID**
* 当写日志成功后，开始真正的写文件内容

#### 问题
相比于依次写I[v2]，B[v2]和Db，并行写肯定更快，但是可能会导致数据不一致

![](/images/QQ20170226-232247@2x.png)

#### 优化方法
* 先写TxB，metadata和data，等成功后，再写TxE
* 在内存中合并写，之后再写到磁盘

#### 日志容量问题
![](/images/QQ20170226-233121@2x.png)

增加super block，记录空间使用情况，如果某个Tx已经完成任务就可以在super block中进行标记

#### Db写两次问题
日志是只记录metadata，事务开始时就把Db写入到它应该在的位置

![](/images/QQ20170226-233433@2x.png)

### 最终步骤
1. 写数据：将数据写入到最终位置，等待完成
2. 将元数据写入日志：把TxB和metadata写入日志，等待完成
3. 日志提交：把包含TxE的事务提交block写入日志，等待完成
4. 提交元数据：将元数据写入到它们的最终位置
5. 释放：在super block中记录该事务的空间可以被释放

### 时间线
![](/images/QQ20170226-234128@2x.png)